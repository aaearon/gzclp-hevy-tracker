# Implementation Plan: Import UX Simplification

**Branch**: `004-import-ux-simplification` | **Date**: 2026-01-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-import-ux-simplification/spec.md`

## Summary

Replace the complex 3-dropdown import system (Category + Slot + Stage) with a single "Role" dropdown. This simplifies the data model from 11 slots + 6 categories to 7 roles, where tier (T1/T2/T3) is derived dynamically from role + workout day rather than stored.

## Technical Context

**Language/Version**: TypeScript 5.9 (strict mode enabled)
**Primary Dependencies**: React 18.3, Vite 5.4, Tailwind CSS 4.1
**Storage**: Browser localStorage (key: `gzclp_state`)
**Testing**: Vitest, React Testing Library
**Target Platform**: Web browser (PWA-capable)
**Project Type**: Single-page React application
**Performance Goals**: Sub-second role assignment, instant tier derivation
**Constraints**: No backward compatibility required (clear all data on upgrade)
**Scale/Scope**: Single user, local-first app

## Constitution Check

*No constitution file found. Proceeding with standard simplicity guidelines.*

- Max 3 external dependencies per feature: PASS (no new dependencies)
- Prefer deletion over modification: PASS (removing 6+ files)
- Single source of truth: PASS (role stored, tier derived)

## Project Structure

### Documentation (this feature)

```text
specs/004-import-ux-simplification/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # N/A (codebase well understood)
├── data-model.md        # Included inline below
└── tasks.md             # To be generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
├── components/
│   ├── common/
│   │   ├── RoleDropdown.tsx         # NEW - replaces CategoryDropdown
│   │   └── CollapsibleSection.tsx   # KEEP - reuse for Warmup/Cooldown
│   ├── Dashboard/
│   │   └── index.tsx                # MODIFY - simplify grouping logic
│   ├── Settings/
│   │   ├── index.tsx                # MODIFY - update ExerciseManager usage
│   │   └── ExerciseManager.tsx      # MODIFY - use role instead of category
│   └── SetupWizard/
│       ├── index.tsx                # MODIFY - remove category state
│       └── ImportReviewStep.tsx     # MODIFY - single Role dropdown
├── hooks/
│   └── useExerciseClassifications.ts # DELETE - no longer needed
├── lib/
│   ├── constants.ts                 # MODIFY - add role constants, remove slot constants
│   ├── classification-store.ts     # DELETE - merge into main state
│   ├── sync-queue.ts               # DELETE - not needed for simplified model
│   ├── role-utils.ts               # NEW - tier derivation utilities
│   └── progression.ts              # MODIFY - use role-based lookups
├── types/
│   ├── state.ts                    # MODIFY - add ExerciseRole, remove slot/category
│   └── classification.ts           # DELETE - merge into state.ts
└── App.tsx                          # MODIFY - remove sync queue processing

tests/
├── unit/
│   ├── role-utils.test.ts          # NEW
│   ├── role-dropdown.test.tsx      # NEW
│   └── [delete classification tests]
└── integration/
    ├── import-role-assignment.test.tsx  # NEW
    └── [delete category grouping tests]
```

**Structure Decision**: Single-page application with flat component structure. No backend.

## Data Model

### New Types (src/types/state.ts)

```typescript
// NEW: 7 roles replacing 11 slots + 6 categories
export type ExerciseRole =
  | 'squat'
  | 'bench'
  | 'ohp'
  | 'deadlift'
  | 't3'
  | 'warmup'
  | 'cooldown'

// Main lift roles (exclusive - one exercise each)
export const MAIN_LIFT_ROLES = ['squat', 'bench', 'ohp', 'deadlift'] as const
export type MainLiftRole = typeof MAIN_LIFT_ROLES[number]

// Multi-assign roles (unlimited exercises)
export const MULTI_ASSIGN_ROLES = ['t3', 'warmup', 'cooldown'] as const

// MODIFIED: ExerciseConfig
export interface ExerciseConfig {
  id: string
  hevyTemplateId: string
  name: string
  role: ExerciseRole  // NEW - replaces category, tier, slot, muscleGroup
}

// REMOVED: GZCLPSlot type (t1_squat, t2_bench, etc.)
// REMOVED: ExerciseCategory from classification.ts
// REMOVED: tier, slot, category, muscleGroup fields from ExerciseConfig
```

### Tier Derivation Logic (src/lib/role-utils.ts)

```typescript
import type { ExerciseRole, GZCLPDay, Tier } from '@/types/state'

const T1_MAPPING: Record<GZCLPDay, MainLiftRole> = {
  A1: 'squat',
  B1: 'ohp',
  A2: 'bench',
  B2: 'deadlift',
}

const T2_MAPPING: Record<GZCLPDay, MainLiftRole> = {
  A1: 'bench',
  B1: 'deadlift',
  A2: 'squat',
  B2: 'ohp',
}

export function getTierForDay(role: ExerciseRole, day: GZCLPDay): Tier | null {
  if (role === 'warmup' || role === 'cooldown') return null
  if (role === 't3') return 'T3'

  if (T1_MAPPING[day] === role) return 'T1'
  if (T2_MAPPING[day] === role) return 'T2'
  return null // Not scheduled for this day
}

export function getExercisesForDay(
  exercises: Record<string, ExerciseConfig>,
  day: GZCLPDay
): { t1: ExerciseConfig | null; t2: ExerciseConfig | null; t3: ExerciseConfig[]; warmup: ExerciseConfig[]; cooldown: ExerciseConfig[] } {
  // Implementation derives from role + day
}
```

### Storage Migration (one-time clear)

```typescript
// On app load, check for old schema and clear
const CURRENT_SCHEMA_VERSION = '2.0.0' // Bump from 1.0.0

function migrateStorage(): void {
  const stored = localStorage.getItem('gzclp_state')
  if (stored) {
    const state = JSON.parse(stored)
    if (state.version !== CURRENT_SCHEMA_VERSION) {
      // Clear all data per FR-014
      localStorage.removeItem('gzclp_state')
      localStorage.removeItem('gzclp_classifications')
      localStorage.removeItem('gzclp_sync_queue')
      // Show re-setup prompt (handled by App.tsx detecting empty state)
    }
  }
}
```

## Implementation Phases

### Phase 1: Core Type Changes (Foundation)

**Goal**: Establish new data model without breaking existing code.

1. **Add new types to state.ts**
   - Add `ExerciseRole` type
   - Add `MAIN_LIFT_ROLES`, `MULTI_ASSIGN_ROLES` constants
   - Keep old types temporarily for reference

2. **Create role-utils.ts**
   - `getTierForDay(role, day)` function
   - `getExercisesForDay(exercises, day)` function
   - `isMainLiftRole(role)` type guard
   - `ROLE_DISPLAY_NAMES` constant

3. **Update constants.ts**
   - Add `EXERCISE_ROLES` array
   - Add `ROLE_DISPLAY` metadata (label, description, color)
   - Keep old slot constants temporarily

**Files**: `src/types/state.ts`, `src/lib/role-utils.ts`, `src/lib/constants.ts`
**Tests**: `tests/unit/role-utils.test.ts`

### Phase 2: New Components

**Goal**: Build new UI components before removing old ones.

1. **Create RoleDropdown.tsx**
   - Props: `value`, `onChange`, `disabled`, `excludeRoles` (for main lift exclusivity)
   - Shows all 7 roles with display names
   - Disables already-assigned main lift roles

2. **Modify CollapsibleSection.tsx**
   - Already exists - verify it meets needs
   - Add `defaultOpen` prop if missing

**Files**: `src/components/common/RoleDropdown.tsx`
**Tests**: `tests/unit/role-dropdown.test.tsx`

### Phase 3: Import Flow Refactor

**Goal**: Simplify ImportReviewStep to use single Role dropdown.

1. **Update ImportReviewStep.tsx**
   - Remove Category + Slot dropdowns
   - Add single Role dropdown per exercise
   - Add weight input only for main lift roles
   - Track assigned main lifts to prevent duplicates
   - Block "Continue" until all exercises have roles

2. **Update SetupWizard/index.tsx**
   - Remove `exerciseCategories` state
   - Remove `onSaveClassifications` callback
   - Pass role assignments directly to state

3. **Update ImportedExercise type**
   - Replace `slot` with `role?: ExerciseRole`
   - Remove `userSlot`

**Files**: `src/components/SetupWizard/ImportReviewStep.tsx`, `src/components/SetupWizard/index.tsx`, `src/types/state.ts`
**Tests**: `tests/integration/import-role-assignment.test.tsx`

### Phase 4: Dashboard Simplification

**Goal**: Update Dashboard to use role-based grouping with tier derivation.

1. **Update Dashboard/index.tsx**
   - Replace `exercisesByCategory` with role-based grouping
   - Use `getExercisesForDay()` for current day display
   - Remove SupplementalBadge usage
   - Keep CollapsibleSection for Warmup/Cooldown

2. **Update NextWorkout.tsx**
   - Use `getTierForDay()` for T1/T2 display
   - Show derived tier labels

3. **Update ExerciseCard.tsx** (if needed)
   - Remove slot-based logic

**Files**: `src/components/Dashboard/index.tsx`, `src/components/Dashboard/NextWorkout.tsx`
**Tests**: `tests/integration/dashboard-role-grouping.test.tsx`

### Phase 5: Settings & Role Management

**Goal**: Update ExerciseManager to allow role changes with conflict handling.

1. **Update ExerciseManager.tsx**
   - Use RoleDropdown instead of CategoryDropdown
   - Implement main lift conflict detection
   - Add role swap modal/confirmation

2. **Update Settings/index.tsx**
   - Update section title to "Exercise Roles"

**Files**: `src/components/Settings/ExerciseManager.tsx`, `src/components/Settings/index.tsx`
**Tests**: `tests/unit/exercise-manager.test.tsx`

### Phase 6: Storage Migration & Cleanup

**Goal**: Implement data clearing and remove obsolete code.

1. **Add migration logic to App.tsx**
   - Check schema version on load
   - Clear all localStorage if old version
   - Show re-setup prompt for returning users

2. **Update progression.ts**
   - Use role-based lookups instead of slot-based

3. **Delete obsolete files**:
   - `src/types/classification.ts`
   - `src/lib/classification-store.ts`
   - `src/lib/sync-queue.ts`
   - `src/hooks/useExerciseClassifications.ts`
   - `src/components/common/CategoryDropdown.tsx`
   - `src/components/common/SupplementalBadge.tsx`
   - `src/components/SetupWizard/ConflictResolutionModal.tsx`

4. **Delete obsolete tests**:
   - All `classification-store`, `sync-queue`, `useExerciseClassifications` tests
   - `supplemental-badge`, `conflict-resolution` tests

5. **Remove from state.ts**:
   - `GZCLPSlot` type
   - Old `slot`, `category`, `tier`, `muscleGroup` fields from `ExerciseConfig`

6. **Remove from constants.ts**:
   - `T1_SLOTS`, `T2_SLOTS`, `T3_SLOTS`, `ALL_SLOTS`
   - `SLOT_NAMES`, `SLOT_MAPPING`, `SLOT_DEFAULT_MUSCLE_GROUP`

**Files**: Multiple deletions and cleanups
**Tests**: Delete obsolete, verify remaining pass

### Phase 7: Final Validation

**Goal**: Ensure all tests pass and app works end-to-end.

1. Run full test suite
2. Manual testing of import flow
3. Verify Dashboard displays correctly for all day types (A1, B1, A2, B2)
4. Verify Settings role change with conflict handling
5. Verify storage migration clears old data

## Files Summary

### Files to CREATE (4)
| File | Purpose |
|------|---------|
| `src/lib/role-utils.ts` | Tier derivation and role utilities |
| `src/components/common/RoleDropdown.tsx` | Role selection dropdown component |
| `tests/unit/role-utils.test.ts` | Unit tests for role utilities |
| `tests/unit/role-dropdown.test.tsx` | Unit tests for RoleDropdown |

### Files to MODIFY (10)
| File | Changes |
|------|---------|
| `src/types/state.ts` | Add ExerciseRole, remove GZCLPSlot, update ExerciseConfig |
| `src/lib/constants.ts` | Add EXERCISE_ROLES/ROLE_DISPLAY, remove SLOT_* constants |
| `src/components/SetupWizard/ImportReviewStep.tsx` | Single Role dropdown, conditional weight input |
| `src/components/SetupWizard/index.tsx` | Remove category state, simplify save logic |
| `src/components/Dashboard/index.tsx` | Role-based grouping, remove Supplemental section |
| `src/components/Dashboard/NextWorkout.tsx` | Use getTierForDay() |
| `src/components/Settings/ExerciseManager.tsx` | Use RoleDropdown with conflict handling |
| `src/components/Settings/index.tsx` | Update section title |
| `src/lib/progression.ts` | Role-based lookups |
| `src/App.tsx` | Add migration logic, remove sync queue |

### Files to DELETE (12)
| File | Reason |
|------|--------|
| `src/types/classification.ts` | Merged into state.ts |
| `src/lib/classification-store.ts` | No longer needed |
| `src/lib/sync-queue.ts` | No longer needed |
| `src/hooks/useExerciseClassifications.ts` | No longer needed |
| `src/components/common/CategoryDropdown.tsx` | Replaced by RoleDropdown |
| `src/components/common/SupplementalBadge.tsx` | Supplemental concept removed |
| `src/components/SetupWizard/ConflictResolutionModal.tsx` | No longer needed |
| `tests/unit/classification-store.test.ts` | Testing deleted code |
| `tests/unit/sync-queue.test.ts` | Testing deleted code |
| `tests/unit/useExerciseClassifications.test.ts` | Testing deleted code |
| `tests/unit/supplemental-badge.test.tsx` | Testing deleted code |
| `tests/integration/conflict-resolution.test.tsx` | Testing deleted code |

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Breaking existing users | FR-014: Clear all data with prompt explaining re-setup required |
| Hevy API unavailable during import | FR-015: Block import until connection restored |
| Role conflict during Settings change | Implement swap confirmation modal |
| Incorrect tier derivation | Comprehensive unit tests for all day/role combinations |

## Complexity Tracking

No constitution violations to justify. This feature reduces complexity:
- Types: 7 roles vs 11 slots + 6 categories
- Fields: 1 field (role) vs 4 fields (slot, category, tier, muscleGroup)
- Components: 1 dropdown vs 2 dropdowns
- Files deleted: 12

## Definition of Done

- [ ] All Phase 1-7 tasks complete
- [ ] All tests pass (`npm test`)
- [ ] Lint passes (`npm run lint`)
- [ ] Build succeeds (`npm run build`)
- [ ] Manual testing: Import flow works with single Role dropdown
- [ ] Manual testing: Dashboard shows correct T1/T2 for each day type
- [ ] Manual testing: Settings role change with conflict swap works
- [ ] Manual testing: Old data cleared on upgrade with re-setup prompt
